# Stock Exchange

The following is a documentation on what this code base entails.

## Installation

    Please follow these installation steps carefully.

* Install NodeJS
* Install Yarn (or npm comes bundled with NodeJS)
* Install docker and docker compose.
* Rename `env.sample` to `.env`. Please note the leading period `'.'` in `.env`
* Run `yarn start` or `npm start`. (This basically runs `docker-compose up --build`)
* Once the startup process is complete the API should be available on: http://localhost:3000/api

* A simple test for the API with data would be structured as :
  http://localhost:3000/api?countrycode=US&Category=Automobile&BaseBid=9 .

This should return a simple message saying: `"Winner = C3"`

## Running Tests

This project comes equipped with unit an integration tests.
In order to test, please do the following:

* Ensure that you have followed the steps listed under installation (especially installiing docker, docker-compose and NodeJS) before following these steps.
* Run `yarn test` or `npm test`. It starts up the containers and executes the test within the container. A code coverage calculation tool (`Istanbul`) is used to also provide coverage results for the included tests.
  You should see the following results:

<img src ="https://user-images.githubusercontent.com/1958765/37858516-c07fdd28-2f05-11e8-9b30-00e1ebeb776e.png" with="400"/>

As well this:

<img src="https://user-images.githubusercontent.com/1958765/37858518-c53fcf76-2f05-11e8-9cbb-9d95a2549890.png" width="800" />

Istanbul generates a directory called coverage under `<project root>/app/coverage`.
Double clicking the index.html file will show the coverage reports interactively on a browser. More information at the bottom of the page.

## How the code works

The repository / project code has the following folder structure:

* <b>app</b> - This contains the server code for the api
* <b>bin</b> - This contains entrypoint scripts and travis scripts
* <b>logs</b> - This will be the location for the log output generated by the API during normal operation or during test run.

## app directory

The app directory houses the server code as well as the Dockerfile for the exchange service. The list of directories and what they contain is as follows:

* <b>config</b> - the database configuration file (config.js) and the docker entrypoint script (entrypoint.sh) are place in this directory
* <b>exchange</b> - This contains the exchange service logic and request handler in the file call called index.js. It also has the Log manager class exported from the log.js file.
* <b>migrations</b> - This houses the migration file for creating the companies database table.
* <b>models</b> - the database schema is placed in the model file. This allows sequelize (the orm used on the project) know exactly what structure the database tables have as well as what their data types are and uses that to map the database tables.
* <b>seeders</b> - The test data provided by the question was used to create database seeds to test the API logic.
* <b>test</b> - the tests for the api

Asides the directories listed above, the following files are also present:

* .dockerignore
* .editorconfig
* app.js
* Dockerfile
* package.json
* server.js
* yarn.lock

## Exchange API End to End process

The API was implemented following the below specifications:

1.  A bid is submitted via an API call passing the following paramteres

    * Country
    * BaseBid
    * Category

Using these with values as query paramters, the API extracts these items and carries out the followinng validations:

1.  <b>Base Targeting check:</b> Here we check for a match for the supplied category and country. If we find a match in the database, we log this using the example format:

    `BaseTargeting: {C1, Passed},{C2, Failed},{C3, Passed}`

Companies that pass this first check are then allowed to go through the next steps.

2.  <b>Budget Check:</b> Here we check that the successful companies indeed have a budget to sell stock. This is done by comparing the comapny's bid to the Budget. If the company budget exceeds the quantity of the bid the company is said to have passed budget check. We then log a message like so:

    `BudgetCheck: {C1,Passed},{C3,Passed}`

When companies pass the budget check they continue on to the next step.

3.  <b>BaseBid check:</b> This checks the BaseBid supplied to the API against the bid stored for a company in the database. If the company's bid is higher, we eliminate this company. Companies whose bids are within range (i.e. less than what is offered) are allowed to go on as passed. This means that when a new bid comes through the API, the BaseBid has to be more than the company Bid in the database.

When the check is complete we log the following message to file:

BaseBid: {C1,Failed},{C2,Failed},{C3,Failed}

Successful companies go on for shortlisting

4.  <b>Shortlisting:</b> Here we sort the successful companies by their Bid values. We return the highest value as the winner.

The API caller returns the CompanyID as the winner and logs an output to the log file like so:

Winner = C2

5.  <b>Reduce Budget:</b> Once the winner has been idenified, the company's bid is subtracted from the budget in the database.

## Tests

In order to run the tests, I have included a number of options depending on your configuration.

The following commands are available to make this a smooth processs:

    - npm test
    - npm start

The tests brings up the containers and executes the unit and integration tests within the container while logging the spec reports to the console.
I have also included coverage reports as shown above indicating that the code is well covered.

The coverage reports are generated and place in `<root folder>/app/coverage`

I chose html and text so you can see the coverage on the console as well as in the browser.
